<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gra</title>
    <link rel="stylesheet" href="style.css" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
<!--        <script src="main.js"></script>-->
</head>
</head>
<body>
<div id="app" >
    <script>
        // src="main.js"


        const appDiv = document.getElementById('app')

        let config = {
            type: Phaser.AUTO,
            width: 900,
            height: 500,
            parent: appDiv,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: {y: 500},
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        }


        let game = new Phaser.Game(config)


        function preload() {
          //  this.load.baseURL = 'https://examples.phaser.io/assets/';
           // this.load.path = 'assets/'
            this.load.crossOrigin = 'anonymous'

            this.load.image('background', 'https://examples.phaser.io/assets/skies/starfield.png')
            this.load.image('platform', 'https://examples.phaser.io/assets/particles/square.png')

            this.load.spritesheet('player',
                'https://examples.phaser.io/assets/games/starstruck/dude.png',
                { frameWidth: 32, frameHeight: 48 }
            )

            this.load.image('star', 'https://examples.phaser.io/assets/particlestorm/particles/snowflake.png')

            this.load.image('enemy', 'https://examples.phaser.io/assets/demoscene/ball-tlb.png')
        }

        let player, platforms, stars, enemies
        let cursors
        let score = 0
        let GAME_WIN = false
        let GAME_OVER = false
        let gameOverText
        let gameWinText
        let scoreText
        let time = 0
        let timeText

        function create() {
            let back = this.add.tileSprite(0, 28, 1000, 450, 'background')
            back.setOrigin(0)
            back.setScrollFactor(0)
            this.cameras.main.setBounds(0, 0, 1000, 500)
            this.physics.world.setBounds(0, 0, 1000, 480)
            player = this.physics.add.sprite(Phaser.Math.FloatBetween(200, 600), 100, 'player')
            player.setCollideWorldBounds(true)
            player.setBounce(0.2)
            this.cameras.main.startFollow(player)

            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
                frameRate: 10,
                repeat: -1
            })

            this.anims.create({
                key: 'front',
                frames: [{ key: 'player', frame: 5 }],
                frameRate: 20
            })

            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('player', { start: 4, end: 5 }),
                frameRate: 10,
                repeat: -1
            })

            cursors = this.input.keyboard.createCursorKeys()

            timeText = this.add.text(this.physics.world.bounds.centerX, 40, 'time: 0', { fontSize: '32px', fill:
                    '#fff', align: "center"})
            scoreText = this.add.text(this.physics.world.bounds.centerX, 16, 'score: 0', { fontSize: '32px', fill:
                    '#fff', align: "center"})

            gameOverText = this.add.text(this.physics.world.bounds.centerX, 250,
                'GAME OVER',
                {font: "40px Arial", fill: "#ffffff", align: "center"})
            gameOverText.setOrigin(0.5)
            gameOverText.visible = false

            gameWinText = this.add.text(this.physics.world.bounds.centerX, 250,
                'YOU WIN',
                {font: "40px Arial", fill: "#ffffff", align: "center"})
            gameWinText.setOrigin(0.5)
            gameWinText.visible = false

            platforms = this.physics.add.staticGroup()
            platforms.create(250, 420, 'platform')
            platforms.create(430, 330, 'platform')
            platforms.create(150, 360, 'platform')
            platforms.create(70, 300, 'platform')
            platforms.create(520, 390, 'platform')
            platforms.create(610, 340, 'platform')
            platforms.create(200, 250, 'platform')
            platforms.create(300, 200, 'platform')
            platforms.create(400, 150, 'platform')
            platforms.create(450, 100, 'platform')
            platforms.create(500, 150, 'platform')
            platforms.create(620, 200, 'platform')
            platforms.create(700, 280, 'platform')
            platforms.create(770, 250, 'platform')
            platforms.getChildren().forEach(c => c.setScale(0.3, 0.1).setOrigin(0).refreshBody())

            this.physics.add.collider(player, platforms)

            stars = this.physics.add.group({
                key: 'star',
                setScale: { x: 0.2, y: 0.2 },
                repeat: 11,
                setXY: { x: 12, y: 0, stepX: 70 },

            })
            stars.children.iterate(function (child) {

                child.setCollideWorldBounds(true)
                child.setBounceY(Phaser.Math.FloatBetween(0.1, 0.3))

            })
            this.physics.add.collider(stars, platforms)
            this.physics.add.overlap(player, stars, collectStar, null, this)

            enemies = this.physics.add.group({
                key: 'enemy',
                setScale: { x: 0.7, y: 0.7 },
                repeat: 3,
                setXY: { x: 12, y: 0, stepX: 200 },


            })
            enemies.children.iterate(function (child) {
                child.setCollideWorldBounds(true)
                child.setBounceX(1)
                child.setBounceY(1)

                child.body.setVelocityX(Phaser.Math.FloatBetween(-150, 150))
            })
            this.physics.add.collider(enemies, platforms)
            this.physics.add.collider(enemies, enemies)
            this.physics.add.collider(player, enemies, gameOver, null, this)

            console.log(enemies)
        }


        function update() {
            if (!GAME_OVER && !GAME_WIN) time ++

            timeText.setText('time: ' + time)
            timeText.setX(player.body.x*0.5+200)
            scoreText.setX(player.body.x*0.5+200)
            if (cursors.left.isDown) {
                player.setVelocityX(-150)
                player.anims.play('left', true)
            }
            else if (cursors.right.isDown) {
                player.setVelocityX(150)
                player.anims.play('right', true)
            }
            else {
                player.setVelocityX(0)
                player.anims.play('front')
            }

            if (cursors.up.isDown && (player.body.touching.down || player.body.onFloor())) {
                player.setVelocityY(-350);
            }
            enemies.children.iterate(function (enemy) {
               enemyMovie(enemy)
            })


        }
        function collectStar (player, star)
        {
            if (!GAME_OVER && !GAME_WIN )
            {
                star.disableBody(true, true)

                score += 10
                scoreText.setText('score: ' + score)

                if (score === 120) {
                    gameWin()
                }
            }

        }
        function gameWin () {
            GAME_WIN = true
            gameWinText.visible = true
        }
        function gameOver ()
        {
            if (!GAME_WIN){
                GAME_OVER = true
                gameOverText.visible = true
            }


        }
        function enemyMovie (enemy) {
            if (time % 150 === 0) enemy.body.velocity.x *= -1
        }

    </script>
</div>
<footer>
    Projekt 2 - Patrycja ReÄ‡ko, Magdalena Sawicka
</footer>
</body>
</html>